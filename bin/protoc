#!/bin/sh

# find all .proto files
files=$(find services/ -type f -name "*.proto")

echo "Found $(echo "$files" | wc -l) .proto files to process"

for f in $files; do
  dir=$(dirname "$f")

  package_name=$(basename "$dir")
  out_path="lib/grpc/$package_name"

  # Show progress for each file
  echo "Processing: $f"
  echo "  Generating output in: $out_path"

  mkdir -p "$out_path"

  protoc \
    --proto_path="$dir" \
		--go_out="$out_path" --go_opt=paths=source_relative \
		--go-grpc_out="$out_path" --go-grpc_opt=paths=source_relative \
		"$f"

  echo "  Done processing: $f"
done

echo "Done!"
